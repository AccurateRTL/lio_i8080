# lio_i8080

## Назначение

Контроллер дисплея lio_i8080 предназначен для управления работой дисплея через параллельную шину i8080 шириной 8 или 16 бит. Контроллер обеспечивает возможность использования внешнего контроллера DMA для избавления процессора от обмена данными с дисплеем.

## Интерфейс

### Входы синхронизации и сброса
### Стандартные интерфейсы
### Нестандартные интерфейсы

## Принцип работы контроллера 
 
В зависимости от текущей задачи пользователя контроллер может использоваться следующими способами: в режиме моста или в режиме самостоятельного исполнения заданий. 

### Режим моста

В режиме моста контроллер выполняет трансляцию обращений по адресу I8080_WINDOW_REG в соответствующие транзакции на шине i8080. Тип обращения (запись или чтение) по данному адресу определяет тип транзакции на шине i8080. 
31-й бит слова данных определяет значение сигнала DC (команда/данные) на шине i8080. 
Младшие 16 или 8 бит (в зависимости от выбранной ширины интерфейса) содержат сами данные. Обращения являются блокирующими, то есть, транзакция на шине AXI Lite завершится только тогда, когда будет завершена соответствующая ей транзакция на шине i8080. 
Например (при выбранной ширине интерфейса 16 бит):
    - запись слова 0х80001234 по адресу I8080_WINDOW_REG вызовет формирование на шине i8080 транзакции записи слова данных 0х1234 при установленном в 1 сигнале DC.
    - чтение по адресу I8080_WINDOW_REG вызовет формирование на шине i8080 транзакции чтения. Считанные по шине i8080 данные будут возвращены в двух младших байтах считанного на AXI Lite слова.

### Режим самостоятельного исполнения заданий

  В режиме самостоятельного исполнения заданий, контроллер выполняет задания, помещаемые в FIFO команд.

### Виды заданий

  Определено 4 вида заданий.
  
   |   Название      |  Значение  | Описание                                                               |
   | --------------- | ---------- | ---------------------------------------------------------------------- |
   |  WRITE_CMD      |     0x0    | Выдать на шине i8080 тразакцию "запись команды".                       |
   |  WRITE_PARAM    |     0x1    | Выдать на шине i8080 тразакцию "запись одиночного параметра".          |
   |  WRITE_N_PARAM  |     0x2    | Выдать на шине i8080 тразакцию "запись N параметров".                  |
   |  SYNC_CMD       |     0x3    | Ожидать/выдать событие                                                 |
   
  Команды имеют следующий формат.
  
#### Задание "запись команды" (WRITE_CMD)
   
   |     Биты    |  Значение  |  Описание                                                                  |
   | ----------- | ---------- | -------------------------------------------------------------------------- |
   |    31:30    |    0x0     | Код команды WRITE_CMD.                                                     |
   |    15:0     |    cmd     | Значение, которое должно быть выдано на шине i8080 в виде команды.         |
                                                                                                          
#### Задание "запись параметра" (WRITE_PARAM)                                                              
   
   |     Биты    | Значение  |  Описание                                                                         |
   | ----------- |---------- | --------------------------------------------------------------------------------- |
   |    31:30    |   0x1     |  Код команды WRITE_PARAM.                                                         |
   |    15:0     |   cmd     |  Значение, которое должно быть выдано на шине i8080 в виде параметра команды.     |
    
#### Задание "запись N параметров" (WRITE_N_PARAM)
   
   |     Биты    |  Значение  |  Описание                                                                            | 
   | ----------- | ---------- | ------------------------------------------------------------------------------------ |
   |    31:30    |    0x2     | Код команды WRITE_N_PARAM.                                                           |
   |    23:0     |     N      | Количество байт, которое должно быть выдано на шине i8080 в виде параметров команды. |

#### Задание "синхронизация" (SYNC)
   
   |     Биты    |  Значение  |  Описание                                                                    |
   | ----------- | ---------- | ---------------------------------------------------------------------------- |
   |    31:30    |    0x3     |  Код команды SYNC.                                                           |
   |      1      |  TE_sync   |  Ожидать получение строба синхронизации с разверткой TE.                     |
   |      0      |    Int     |  Выдать прерывание для процессора.                                           |
                              
#### Выполнение заданий

  1. При получении задания WRITE_CMD контроллер выполняет на шине i8080 транзакцию записи команды с кодом, заданным в младших байтах задания. 
  2. При получении задания WRITE_PARAM контроллер выполняет на шине i8080 транзакцию записи параметра с кодом, заданным в младших байтах задания.
  3. При получении задания WRITE_N_PARAM контроллер выполняет на шине i8080 запись нескольких параметров, количество которых задается в младших 3 байтах задания. Сами значения параметров при этом считываются из 32-х битного FIFO данных. 
  4. Запись и в FIFO команд, и в FIFO данных блокирующая - если в каком-либо из этих FIFO нет места, то транзакция записи в него на шине AXI Lite не будет завершена до тех пор, пока в данном FIFO не освободится место. Флаги FIFO доступны в регистре флагов FIFO. Глубина каждого из FIFO 4 слова. 
  5. Задание SYNC может быть использовано для синхронизации с управляющей контроллером программой. Для этого в данном задании должен быть установлен бит Int. В этом случае, результатом выполнения данного задания станет генерация строба прерывания.
  6. Задание SYNC может быть использовано для синхронизации с вертикальной разверткой дисплея путем использования сигнала TE. Для этого в данном задании должен быть установлен бит TE_sync. В этом случае, результатом выполнения данного задания станет ожидание контроллером получение восходящего фронта сигнала TE.
  7. Задание SYNC может быть использовано для определения момента фактического завершения предыдущих заданий контроллером без использования прерываний. В этом случае в пустое FIFO заданий помещаются необходимые задания, после них помещается задание SYNC без установленных управляющих битов, процессор начинает опрашивать регистр флагов FIFO. Момент фактического завершения выполнения всех заданий может быть определен по установке флага опустошения FIFO заданий. 

  
  
  
## Программная модель контроллера


### Карта памяти

|  Смещение    |  Название                   |  Доступ  |   Описание                                             |
| ------------ | --------------------------- | -------- | ------------------------------------------------------ |
|     0x00     |   I8080_VERSION_REG         |    RO    |  Версия контроллера                                    |
|     0x04     |   I8080_CONFIG_REG_0        |    RW    |  Конфигурационный регистр №1                           |
|     0x08     |   I8080_CONFIG_REG_1        |    RW    |  Конфигурационный регистр №2                           |
|     0x0C     |   I8080_WINDOW_REG          |    RW    |  Окно на шину i8080.                                   |
|     0x10     |   I8080_CMD_FIFO            |    WO    |  FIFO заданий                                          |
|     0x14     |   I8080_DATA_FIFO           |    WO    |  FIFO данных для записи                                |
|     0x18     |   I8080_CSN_REG             |    RW    |  Регистр управления сигналом CSN интерфейса i8080      |
|     0x1С     |   I8080_FIFO_STATUS_REG     |    RO    |  Регистр флагов FIFO                                   |

### Конфигурационный регистр №1

|    Биты   |    Название        |  Описание                                                                       |
| --------- | ------------------ | ------------------------------------------------------------------------------- |
|   31:24   |    cfg_rd_1_len    |  Длина интервала в тактах (задавать на 1 меньше), на котором сигнал RD равен 1  |
|   23:16   |    cfg_rd_0_len    |  Длина интервала в тактах (задавать на 1 меньше), на котором сигнал RD равен 0  |
|   15:8    |    cfg_wr_1_len    |  Длина интервала в тактах (задавать на 1 меньше), на котором сигнал WR равен 1  |
|    7:0    |    cfg_wr_0_len    |  Длина интервала в тактах (задавать на 1 меньше), на котором сигнал WR равен 0  |

### Конфигурационный регистр №2

|     Биты   |    Название      |  Описание                                                                                  | 
| ---------- | ---------------- | ------------------------------------------------------------------------------------------ | 
|   31:16    |  cfg_te_delay    |  Задержка от момента получения сигнала TE до начала выполения заданий                      | 
|     5      |  cfg_inv_dc      |  Меняет полярность сигнала DC для режима выполнения заданий на противоположную: 1 - команда, 0 - данные |
|     4      |  RSTn            |  Управление сигналом сброса дисплея.                                                       | 
|    1:0     |  cfg_if_sz       |  Ширина шины данных интерфейса i8080 в байтах. Допустимые значения 1 (8 бит) и 2 (16 бит). | 

### Окно на шину i8080

|     Биты   |    Название        |  Описание                                                                            |
| ---------- | ------------------ | ------------------------------------------------------------------------------------ | 
|    31      |        Сmd         |  Признак того, что выставляемое на шину данных значение является командой.           |
|   15:0     |     Data_i8080     |  Значение, выставляемое на шину данных, или считываемое с нее.                       |

### FIFO заданий  

|     Биты   |    Название        |  Описание                                                                            |
| ---------- | ------------------ | ------------------------------------------------------------------------------------ | 
|   31:0     |   Task_FIFO_DI     |  Порт записи FIFO заданий.                                                           |
                                                                                                                         |
### FIFO данных  

|     Биты   |    Название        |  Описание                                                                            |
| ---------- | ------------------ | ------------------------------------------------------------------------------------ |
|   31:0     |   Data_FIFO_DI     |  Порт записи в FIFO данных для задания WRITE_N_PARAM.                                |
                                                                                                                        
### Регистр управления сигналом CSN   

|    Биты   |    Название        |  Описание                                                                             | 
| --------- | ------------------ | ------------------------------------------------------------------------------------- |
|     0     |       CSN          |  Значение сигнала CSN.                                                                |

### Регистр флагов FIFO  

|   Биты   |    Название        |  Описание                                                                       |
| -------- | ------------------ | ------------------------------------------------------------------------------- |
|    3     |  data_fifo_full    |  FIFO данных полное                                                             |
|    2     |  data_fifo_empty   |  FIFO данных пустое                                                             |
|    1     |  cmd_fifo_full     |  FIFO команд полное                                                             |
|    0     |  cmd_fifo_empty    |  FIFO команд пустое                                                             |

### Прерывания

Единственным источником прерывания от контроллера может быть только выполнение задания SYNC, с установленным битом Int.





## Руководство программиста


### Инициализация контроллера

1. С помощью регистра I8080_CONFIG_REG_0_OFS задать параметры стробов записи и чтения. 
2. С помощью регистра I8080_CONFIG_REG_1_OFS задать ширину интерфейса, задержку после получение TE (при необходимости) и снять сигнал сброса. 

### Работа через окно на шину i8080

1. Путем обращения по адресу I8080_WINDOW_REG выдавать необходимые транзакции на шину i8080. 

### Работа в режиме выполнения заданий.

1. Записать команды для формирования необходимых транзакций i8080 в FIFO команд.
2. При необходимости записать параметры в FIFO записываемых данных.
3. При необходимости записать команду SYNC с установленным битом Int для получения прерывания о завершении выполнения заданий.

### Интеграция с DMA

1. Записать команды для формирования необходимых транзакций i8080 в FIFO команд.
2. Настроить контроллер DMA для копирования данных из памяти процессора в FIFO записываемых данных.
3. При необходимости записать команду SYNC с установленным битом Int для получения прерывания о завершении выполнения заданий.

### Работа в режиме синхронизации с разверткой

1. Записать команду SYNC с установленным битом TE_sync для ожидания получения сигнала TE.
2. Записать команды для формирования необходимых транзакций i8080 в FIFO команд.
3. При необходимости настроить контроллер DMA для копирования данных из памяти процессора в FIFO передаваемых данных.
4. При необходимости записать команду SYNC с установленным битом Int для получения прерывания о завершении выполнения заданий.


## Руководство по интеграции IP блока

### Особенности синхронизации
### Особенности сброса
### Адресное пространство

